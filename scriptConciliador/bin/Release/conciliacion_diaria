#!/bin/bash

# Cargar las confiuguraciones
. ./configuracion

function sql_eve {
SELECT_DATE="'"$D"'"
TNS_ADMIN=/opt/instantclient  $SQLPLUS -S ${ORACLE_USERNAME}/${ORACLE_PASSWORD}@${ORACLE_TNSNAME} > /home/usrEVEMQ/soporte/conciliacion_diaria/temp/$SQL_EVE <<EOF
set linesize 16000
set pagesize 16000
set colsep ,
set trimspool on
set headsep off
select  unique tc.transaction_id, th.original_authoriser,
        tad.authorisation_code, tad.response_code, tad.authoriser_id,
        to_char(th.transaction_timestamp,'YYYYMMDD'),
        (select sum(amount) from transaction_authorisation_doc where transaction_uid=tc.transaction_uid),
        tad.installments,
        to_char(tcd.capture_date,'YYYYMMDD'),
        (select sum(amount) from transaction_capture_doc where transaction_uid=tc.transaction_uid),
        th.transaction_transport, th.transaction_status, th.transaction_uid, th.inpa
from transaction_current tc
join transaction_hdr th on tc.transaction_uid=th.transaction_uid
join transaction_authorisation_doc tad on tc.transaction_uid=tad.transaction_uid
left join transaction_capture_doc tcd on tc.transaction_uid=tcd.transaction_uid and tcd.document_id=tad.document_id
where to_char(th.transaction_timestamp,'YYYYMMDD')=$SELECT_DATE;
quit;
EOF
}

# Se debe ejecutar ./conciliacion_diaria [anomesdia]
# Si no hay fecha en la linea de comandos entonces es hace dos dias

DATE_TODAY=`date --date='-1 day' +%Y%m%d`
if [ -z $1 ] ; then
        DATE_TO=${DATE_TODAY}
else
        DATE_TO=$1
fi

if [ -z $2 ] ; then
    DATE_FROM=`date --date="${DATE_TO} 01 -14 day" +%Y%m%d`
else
        DATE_FROM=$2
fi
echo "DATE_FROM $DATE_FROM"
echo "DATE_TO $DATE_TO"

# Iterar para traer todos los archivos
for ((D=${DATE_FROM};D<=${DATE_TO};D=`date --date="${D} 01 +1 day" +%Y%m%d`)) ; do
		echo "Processing $D"

		# Crear nombres de archivo
		TBK_KCC=tbk_bitacora_TR_NORMAL_`date --date="${D} 01" +%m%d`.log
		TBK_SOAP=WEBPAY_SOAP-${D}.csv
		TBK_CAPTURE=CAPTURE-${D}.csv
		TBK_CAPTURE_SOAP=CAPTURE_SOAP-${D}.csv
		PRESTO_LIDERCL=LIDERCL`date --date="$D 01" +%d%m%Y`.DAT
		SQL_EVE=sql_eve_${D}.txt
		SQL_MO=sql_mo_${D}.txt

		# solamente ejecutar la generacion de datos en la maquina de produccion de Walmart
		if [ ${HOST_PRODUCCION} == `hostname` ]; then
			for IP in $IP_PRODUCCION ; do
				if [ ! -e /home/usrEVEMQ/soporte/conciliacion_diaria/temp/${IP}_credito_$TBK_KCC ] ; then scp $IP:/opt/kcc/credito/log/$TBK_KCC /home/usrEVEMQ/soporte/conciliacion_diaria/temp/${IP}_credito_$TBK_KCC 2>/dev/null ; fi
				#if [ ! -e /home/usrEVEMQ/soporte/conciliacion_diaria/temp/${IP}_debito_$TBK_KCC ]  ; then scp $IP:/opt/kcc/debito/log/$TBK_KCC  /home/usrEVEMQ/soporte/conciliacion_diaria/temp/${IP}_debito_$TBK_KCC 2>/dev/null  ; fi
				if [ ! -e /home/usrEVEMQ/soporte/conciliacion_diaria/temp/${IP}_$TBK_SOAP ] ; then scp $IP:/home/usrEVEMQ/transbank/$TBK_SOAP /home/usrEVEMQ/soporte/conciliacion_diaria/temp/${IP}_$TBK_SOAP 2>/dev/null ; fi
			done
			if [ "${D}"!="${DATE_TODAY}" ]; then if [ ! -e /home/usrEVEMQ/soporte/conciliacion_diaria/temp/RESP${PRESTO_LIDERCL} ] ; then cp /home/usrEVEMQ/presto/RESP${PRESTO_LIDERCL} /home/usrEVEMQ/soporte/conciliacion_diaria/temp/RESP${PRESTO_LIDERCL} 2>/dev/null ; fi ; fi
			if [ ! -e /home/usrEVEMQ/soporte/conciliacion_diaria/temp/${PRESTO_LIDERCL} ] ; then cp /home/usrEVEMQ/presto/${PRESTO_LIDERCL} /home/usrEVEMQ/soporte/conciliacion_diaria/temp/${PRESTO_LIDERCL} ; fi
			if [ ! -e /home/usrEVEMQ/soporte/conciliacion_diaria/temp/$TBK_CAPTURE ] ; then cp /home/usrEVEMQ/transbank/$TBK_CAPTURE /home/usrEVEMQ/soporte/conciliacion_diaria/temp/$TBK_CAPTURE 2>/dev/null ; fi
			if [ ! -e /home/usrEVEMQ/soporte/conciliacion_diaria/temp/$TBK_CAPTURE_SOAP ] ; then cp /home/usrEVEMQ/transbank/$TBK_CAPTURE_SOAP /home/usrEVEMQ/soporte/conciliacion_diaria/temp/$TBK_CAPTURE_SOAP 2>/dev/null ; fi
	
			#get EVE data
			if [ ! -e /home/usrEVEMQ/soporte/conciliacion_diaria/temp/$SQL_EVE ] ; then
				while [ 1 ]; do
					sql_eve > /home/usrEVEMQ/soporte/conciliacion_diaria/temp/$SQL_EVE
					if [ $? = 0 ]; then break ; fi
					echo Regenerando archivo /home/usrEVEMQ/soporte/conciliacion_diaria/temp/$SQL_EVE
					sleep 1
				done
			fi
	
			# get MO data
			if [ ! -e /home/usrEVEMQ/soporte/conciliacion_diaria/temp/$SQL_MO ] ; then 
				while [ 1 ] ; do
					./mo ${SQL_SERVER_HOST} ${SQL_SERVER_USERNAME} "${SQL_SERVER_PASSWORD}" ${SQL_SERVER_DATABASE} `date --date="${D} 01" +%Y-%m-%d` > /home/usrEVEMQ/soporte/conciliacion_diaria/temp/$SQL_MO
					if [ $? = 0 ]; then break ; fi
					echo Regenerando archivo /home/usrEVEMQ/soporte/conciliacion_diaria/temp/$SQL_MO
					sleep 1
				done
			fi
		fi
	
		# Acumular nombres de archivo
		FILES_EVE+=" /home/usrEVEMQ/soporte/conciliacion_diaria/temp/$SQL_EVE"
		FILES_LIDERCL+=" /home/usrEVEMQ/soporte/conciliacion_diaria/temp/${PRESTO_LIDERCL}"	
		if [ -e /home/usrEVEMQ/soporte/conciliacion_diaria/temp/RESP${PRESTO_LIDERCL} ] ; then FILES_RESPLIDERCL+=" /home/usrEVEMQ/soporte/conciliacion_diaria/temp/RESP${PRESTO_LIDERCL}" ; fi
	
		if [ -e /home/usrEVEMQ/soporte/conciliacion_diaria/temp/$TBK_CAPTURE ]; then FILES_KCC_CAPTURE+=" /home/usrEVEMQ/soporte/conciliacion_diaria/temp/$TBK_CAPTURE" ; fi
		for IP in $IP_PRODUCCION ; do
			if [ -e /home/usrEVEMQ/soporte/conciliacion_diaria/temp/${IP}_credito_$TBK_KCC ] ; then FILES_KCC+=" /home/usrEVEMQ/soporte/conciliacion_diaria/temp/${IP}_credito_$TBK_KCC" ; fi
		done
		if [ -e /home/usrEVEMQ/soporte/conciliacion_diaria/temp/$TBK_CAPTURE_SOAP ] ; then FILES_CAPTURE_SOAP+=" /home/usrEVEMQ/soporte/conciliacion_diaria/temp/$TBK_CAPTURE_SOAP" ; fi
		for IP in $IP_PRODUCCION ; do
			if [ -e /home/usrEVEMQ/soporte/conciliacion_diaria/temp/${IP}_${TBK_SOAP} ] ; then FILES_TBK_SOAP+=" /home/usrEVEMQ/soporte/conciliacion_diaria/temp/${IP}_${TBK_SOAP}" ; fi
		done
		FILES_MO+=" /home/usrEVEMQ/soporte/conciliacion_diaria/temp/$TBK_CAPTURE /home/usrEVEMQ/soporte/conciliacion_diaria/temp/$SQL_MO"
done

ABORT=0
for f in $FILES_EVE $FILES_LIDERCL $FILES_RESPLIDERCL $FILES_MO ; do
#for f in $FILES_EVE $FILES_LIDERCL $FILES_RESPLIDERCL $FILES_KCC_CAPTURE $FILES_KCC $FILES_MO $FILES_TBK_SOAP $FILES_CAPTURE_SOAP ; do
	if [ ! -e $f ] ; then
		echo "Falta archivo $f"
		ABORT=1
	fi
done

if [ $ABORT != 0 ] ; then
	echo "ABORT"
	exit 0
fi

if [ -z $3 ] ; then
        DATE_TO=${DATE_TODAY}
else
        DATE_TO=$1
fi

IN=${EVE_REGEX_TYPE}
types=$(echo $IN | tr "-" "\n")

for type in $types
do
	if [ $type == "EVE_MIDAS" ] ; then 		
		
		if [ -z $1 ] ; then
			if [ -z $2 ] ; then
				DATE_TO2=`date --date='-1 day' +%Y%m%d`
				DATE_FROM2=`date --date="${DATE_TO2} 01 -7 day" +%Y%m%d`
				$MONO EveRegexNET.exe ${DATE_FROM2} ${DATE_TO2} test $type;
			fi
		else			
			$MONO EveRegexNET.exe ${DATE_FROM} ${DATE_TO} test $type;
		fi	
	fi
	
	if [ $type == "EVE_OMS" ] ; then 
		if [ -z $1 ] ; then
			if [ -z $2 ] ; then
				DATE_TO2=`date --date='-1 day' +%Y%m%d`
				DATE_FROM2=`date --date="${DATE_TO2} 01 -7 day" +%Y%m%d`
				$MONO EveRegexNET.exe ${DATE_FROM2} ${DATE_TO2} test $type;				
			fi
		else			
			$MONO EveRegexNET.exe ${DATE_FROM} ${DATE_TO} test $type;
		fi	
	fi
	if [ $type == "EVE_TBK" ] ; then 
		if [ -z $1 ] ; then
			if [ -z $2 ] ; then
				DATE_TO2=`date --date='-1 day' +%Y%m%d`
				DATE_FROM2=`date --date="${DATE_TO2} 01 -7 day" +%Y%m%d`
				$MONO EveRegexNET.exe ${DATE_FROM2} ${DATE_TO2} test $type; 
			fi
		else			
			$MONO EveRegexNET.exe ${DATE_FROM} ${DATE_TO} test $type;
		fi
	fi
	
	if [ $type == "EVE_PRESTO" ] ; then 	
		if [ -z $1 ] ; then
			if [ -z $2 ] ; then
				DATE_TO2=`date --date='-1 day' +%Y%m%d`
				DATE_FROM2=`date --date="${DATE_TO2} 01 -13 day" +%Y%m%d`
			$MONO EveRegexNET.exe ${DATE_FROM2} ${DATE_TO2} test $type;  
			fi
		else			
			$MONO EveRegexNET.exe ${DATE_FROM} ${DATE_TO} test $type;
		fi
	fi
	if [ $type == "CAPTURA_TBK_CREDITO" ] ; then 
		if [ -z $1 ] ; then
			if [ -z $2 ] ; then
				DATE_TO2=`date --date='day' +%Y%m%d`
				DATE_FROM2=`date --date="${DATE_TO2} 01 -7 day" +%Y%m%d`
				$MONO EveRegexNET.exe ${DATE_FROM2} ${DATE_TO2} test $type; 
			fi
		else			
			$MONO EveRegexNET.exe ${DATE_FROM} ${DATE_TO} test $type;
		fi	 
	fi
	if [ $type == "CAPTURA_PRESTO" ] ; then 	
		if [ -z $1 ] ; then
			if [ -z $2 ] ; then
				DATE_TO2=`date --date='-1 day' +%Y%m%d`
				DATE_FROM2=`date --date="${DATE_TO2} 01 -13 day" +%Y%m%d`
				$MONO EveRegexNET.exe ${DATE_FROM2} ${DATE_TO2} test $type; 
			fi
		else			
			$MONO EveRegexNET.exe ${DATE_FROM} ${DATE_TO} test $type;
		fi	 
	fi	   
done
#stdbuf -oL -eL awk -f conciliacion_diaria.awk -v DATE_FROM=${DATE_FROM} -v DATE_TO=${DATE_TO} $FILES_EVE $FILES_LIDERCL $FILES_RESPLIDERCL $FILES_KCC_CAPTURE $FILES_KCC $FILES_TBK_SOAP $FILES_CAPTURE_SOAP $FILES_MO
#stdbuf -oL -eL awk -f conciliacion_diaria.awk -v DATE_FROM=${DATE_FROM} -v DATE_TO=${DATE_TO} $FILES_EVE $FILES_LIDERCL $FILES_RESPLIDERCL $FILES_KCC_CAPTURE $FILES_KCC $FILES_TBK_SOAP $FILES_CAPTURE_SOAP $FILES_MO
